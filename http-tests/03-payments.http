# ============================================================
# API TEST FILE - PAYMENTS
# ============================================================
#
# Test all payment-related endpoints
#
# PREREQUISITE: 
# 1. Run 01-auth.http to get a token
# 2. Run 02-merchants.http to create merchants
# ============================================================

@baseUrl = http://localhost:5000

# Paste your token here after logging in
@token = YOUR_JWT_TOKEN_HERE

# Paste a merchant ID here after creating merchants
@merchantId = YOUR_MERCHANT_ID_HERE

# ============================================================
# 1. INITIATE A PAYMENT
# ============================================================
# Creates a new payment transaction
# Status will be "Pending" until callback is received

### Initiate Payment 1 - 100 THB
# @name payment1
POST {{baseUrl}}/api/payments
Content-Type: application/json
Authorization: Bearer {{token}}

{
    "merchantId": "{{merchantId}}",
    "amount": 100.00,
    "currency": "THB",
    "description": "Coffee purchase"
}

@transaction1Id = {{payment1.response.body.transactionId}}

### Initiate Payment 2 - 250.50 THB
# @name payment2
POST {{baseUrl}}/api/payments
Content-Type: application/json
Authorization: Bearer {{token}}

{
    "merchantId": "{{merchantId}}",
    "amount": 250.50,
    "currency": "THB",
    "description": "Lunch special"
}

@transaction2Id = {{payment2.response.body.transactionId}}

### Initiate Payment 3 - 1500 THB
# @name payment3
POST {{baseUrl}}/api/payments
Content-Type: application/json
Authorization: Bearer {{token}}

{
    "merchantId": "{{merchantId}}",
    "amount": 1500.00,
    "currency": "THB",
    "description": "Electronics purchase"
}

@transaction3Id = {{payment3.response.body.transactionId}}

# ============================================================
# 2. IDEMPOTENCY TEST
# ============================================================
# Same idempotencyKey = Same transaction (no duplicate)

### Payment with Idempotency Key (First request)
# @name idempotentPayment
POST {{baseUrl}}/api/payments
Content-Type: application/json
Authorization: Bearer {{token}}

{
    "merchantId": "{{merchantId}}",
    "amount": 500.00,
    "currency": "THB",
    "description": "Test idempotency",
    "idempotencyKey": "unique-order-12345"
}

### Same Idempotency Key (Should return SAME transaction)
POST {{baseUrl}}/api/payments
Content-Type: application/json
Authorization: Bearer {{token}}

{
    "merchantId": "{{merchantId}}",
    "amount": 500.00,
    "currency": "THB",
    "description": "Test idempotency",
    "idempotencyKey": "unique-order-12345"
}

# ============================================================
# 3. GET TRANSACTION BY ID
# ============================================================

### Get Payment 1 Details
GET {{baseUrl}}/api/payments/{{transaction1Id}}
Authorization: Bearer {{token}}

### Get Payment 2 Details
GET {{baseUrl}}/api/payments/{{transaction2Id}}
Authorization: Bearer {{token}}

### Get Non-existent Transaction (Should return 404)
GET {{baseUrl}}/api/payments/00000000-0000-0000-0000-000000000000
Authorization: Bearer {{token}}

# ============================================================
# 4. GET ALL TRANSACTIONS FOR A MERCHANT
# ============================================================

### Get All Transactions for Merchant
GET {{baseUrl}}/api/payments/merchant/{{merchantId}}
Authorization: Bearer {{token}}

# ============================================================
# 5. PROCESS PAYMENT CALLBACK (Simulating Bank Response)
# ============================================================
# In real life, the bank calls this endpoint
# We simulate it here to test

### Callback: Payment 1 SUCCESS
POST {{baseUrl}}/api/payments/callback
Content-Type: application/json
Authorization: Bearer {{token}}

{
    "transactionId": "{{transaction1Id}}",
    "result": "Success",
    "externalReferenceId": "BANK-REF-001",
    "message": "Payment processed successfully"
}

### Callback: Payment 2 FAILED
POST {{baseUrl}}/api/payments/callback
Content-Type: application/json
Authorization: Bearer {{token}}

{
    "transactionId": "{{transaction2Id}}",
    "result": "Failed",
    "externalReferenceId": "BANK-REF-002",
    "message": "Insufficient funds"
}

### Callback: Payment 3 SUCCESS
POST {{baseUrl}}/api/payments/callback
Content-Type: application/json
Authorization: Bearer {{token}}

{
    "transactionId": "{{transaction3Id}}",
    "result": "Success",
    "externalReferenceId": "BANK-REF-003",
    "message": "Payment completed"
}

# ============================================================
# 6. VERIFY UPDATED TRANSACTIONS
# ============================================================

### Check Payment 1 (Should be Success)
GET {{baseUrl}}/api/payments/{{transaction1Id}}
Authorization: Bearer {{token}}

### Check Payment 2 (Should be Failed)
GET {{baseUrl}}/api/payments/{{transaction2Id}}
Authorization: Bearer {{token}}

### Check Payment 3 (Should be Success)
GET {{baseUrl}}/api/payments/{{transaction3Id}}
Authorization: Bearer {{token}}

# ============================================================
# 7. ERROR CASES
# ============================================================

### Payment to Non-existent Merchant (Should fail)
POST {{baseUrl}}/api/payments
Content-Type: application/json
Authorization: Bearer {{token}}

{
    "merchantId": "00000000-0000-0000-0000-000000000000",
    "amount": 100.00,
    "currency": "THB"
}

### Payment with Negative Amount (Should fail)
POST {{baseUrl}}/api/payments
Content-Type: application/json
Authorization: Bearer {{token}}

{
    "merchantId": "{{merchantId}}",
    "amount": -50.00,
    "currency": "THB"
}

### Payment without Amount (Should fail - validation error)
POST {{baseUrl}}/api/payments
Content-Type: application/json
Authorization: Bearer {{token}}

{
    "merchantId": "{{merchantId}}",
    "currency": "THB"
}
